<html>
<head>  
   <link rel="stylesheet" type="text/css" href="resource/css/style.css">
   <meta charset="ISO-8859-1">
   <title>Insert title here</title>
   <script src='resource/map_scripts/init.js'></script>
   <script src='resource/buttonhandle.js'></script>                 
   <script src='resource/formvalidate.js'></script>              
   <script src='resource/map_scripts/geocode.js'></script>  
   <script src='resource/map_scripts/circledraw.js'></script>      
   <script src='resource/colorboxes.js'></script>           
   <script src="https://maps.googleapis.com/maps/api/js?callback=initMap" async defer></script>
   <script id='bingScript' type='text/javascript'></script>
</head>
<body>
  <br>  
<section>  
  <div class="map" id="map" style="display:inline-block">map goes here.</div>    
  <div id="text" style='display:none'></div>
</section>

<div id="hidden-div" style="display:none">
  <div class="div-color boxes">
      <div class="color-box" id="mood-div" style="background-color: RGB(127,127,127)">Current Tweet Mood</div>
  </div>
  <div class="div-color">
      <div class="color-box2" id="globalMood-div" style="background-color: RGB(127,127,127)">Average Tweet Mood</div>
  </div>
    <br><br>

  <div id='button-div'>
    <table>
      <tr>
        <td>
          <button type="button" id="pause-btn" name='pause' onclick="buttonHandler(this)" method="post">
         </button>
        </td>
        <td> 
          <button type="button" id="clear-btn" name='clear' onclick="buttonHandler(this)" method="post">Clear Map
          </button>
        </td>
        <td>
          <button type="button" id="togCircVis-btn" name='togCircVis' style='display: block' onclick="buttonHandler(this)" method="post">
          </button>
        </td>
        <td> 
          <button type="button" id="togTextVis-btn" name='mapOnly' onclick="buttonHandler(this)" method="post">
          </button>
        </td>            
      </tr>         
    </table>
    <br>      
    <span> Note: You can always pause your streaming, change the parameters in your form, then click 'Resume Mapping'. 
      This will show you your new  results on top of the current map. Hit 'Clear Map' to avoid overlapping results. </span>          
    <br>                                         
  </div>  
    <br><br>       
</div>
  <br>

<!-- Note the use of a button rather than input to submit form; prevents
page refresh, to preserve utility of ajax-->

<div id="form-input">
   <form id="form">
     <fieldset class='central'>
       <legend class='form-text' style='font-size:20'>What would you like to watch?</legend>
       <div id='grp1' style='display:inline-block' class='grp1'>
         <label for='subject'style='display:block' class='label'>
              Choose your subject.<br>
           <input type="text" id="subject" name='subject' value="BernieSanders" style="display:block" class='form-text' onkeyup='buttonHandler(this)'><br>
         </label>   
         <label for='mode' style='display:block' class='label'>
            Select your search mode.<br>   
            <select name="mode" form="form-input" id="mode" class='form-text' onchange="buttonHandler(this)">
              <option value="/getTweets">Search Twitter</option>
              <option value="/streamTweets">Live Stream</option>
            </select>
          </label>
        </div>
        <div id='grp2' style='display:inline-block' class='grp2'>  
         <label for='startdate' style='display:block' id='startlabel' class='label'>
            Choose a start date for a search, up to one week ago: <br>
            <input type="text" id="startdate" value="" placeholder="day/month/2016" style="display:block" class='form-text'><br>
            <div name="error1" id="starterror" style="display:none" class='err'>Not quite. Please correct the following: </div>   
         </label> 
         <label for='enddate' style='display:block' id='endlabel' class='label'>
            Choose an end date for your search: <br>
            <input type="text" id="enddate" value="javascript:setDate()" placeholder="day/month/2016" style="display:block" class='form-text'><br>       
            <div name="error2" id="enderror"  style="display:none" class='err'>Not quite. Please correct the following: </div>   
         </label>
        </div>
         <br><br>
         <button type="button" id="submit-btn" onclick="buttonHandler(this)" name='submit' style='display: block' class='form-text label submit' 
                 method="post">Submit</button>  
     </fieldset>
   </form>
</div>

<script type="text/javascript">

const DefaultCenter = {'lat': -3.8963, 'lng': -146.4255};
const Week = xBrowserWeek();
//document.getElementById('togCirVis-btn').firstChild.data = 'Hide Circles';
(function setDates(){
  var date = new Date();
  var end = (date.getMonth() + 1) + '/' + date.getDate() + '/' + date.getFullYear();
  var start = new Date(date - xBrowserWeek() + 86400 * 1000);
  start = (start.getMonth() + 1) + '/' + start.getDate() + '/' + start.getFullYear();

  document.getElementById('enddate').value = end;
  document.getElementById('startdate').value = start;
})()

// Apparently cross-browser standardization of date construction is not so consistent, so I use this as a golden standard: 
function xBrowserWeek(){
  var pointA = new Date('3/3/2016');
  var pointB = new Date('3/10/2016'); 
  return pointB - pointA;
}

document.getElementById('pause-btn').firstChild.data = 'Pause Mapping';
document.getElementById('togCircVis-btn').firstChild.data = 'Hide Circles';
document.getElementById('togTextVis-btn').firstChild.data = 'Hide Text Crawl';

var bingCallback = function(){};
var panToCircle = function(){};

var xhr = new XMLHttpRequest();
var globalMood = {"mood" : [0,0,0], "count" : 1 };
var geoCoder;
var turnstileCount = 0;
var map;  
var startErrMsg;
var endErrMsg;

// **buttonhandle.js**: See buttonhandle.js for the button handling function. All clicks fire this function. It operates on a switch statement, 
// calling different functions according to the value in the button. 

function pauseStream(){
    // Abort should be sufficient. The request below is a fail safe measure to ensure twitter streaming stops.
  xhr.abort();      
  var pauseXhr = new XMLHttpRequest();
  pauseXhr.open('POST','../pauseStream', true);
  pauseXhr.setRequestHeader('Content-Type','text/plain');
  pauseXhr.send();

  pauseXhr.onreadystatechange = function(){
    if (this.readyState === XMLHttpRequest.DONE && this.status === 200){
      //document.getElementById("text-div").value = 'Streaming paused \n\n' + document.getElementById("text-div").value;
    } else {
        //alert('There was a problem with the request.')
    }
  }
};         

function formSubmit(){
  sendData(serializeForm());
  document.getElementById('togCircVis-btn').style.display = 'block';        
  
  function serializeForm(){
    var data = {'subject' : document.getElementById("subject").value,
                'start'   : document.getElementById("startdate").value,
                'end'     : document.getElementById("enddate").value};

    data.id = map._getLastId.call(map);

    var urlEncodedData = "";
    var urlEncodedDataPairs = [];

    for (var name in data){
        urlEncodedDataPairs.push(encodeURIComponent(name) + '=' + encodeURIComponent(data[name]));
    }
    return [urlEncodedDataPairs.join('&').replace(/%20/g, '+'), document.getElementById("mode").value];
  }

  function sendData(data){
    xhr.open('POST', data[1], true);
    xhr.setRequestHeader('Content-Type','application/x-www-form-urlencoded');
    xhr.send(data[0]);
    xhr.onreadystatechange = function (){
      if ((this.readyState === XMLHttpRequest.LOADING || this.readyState === XMLHttpRequest.DONE) && this.status === 200) {
        var response = this.responseText;
        // '{"text":"'' delimits the start of a new tweet -- the flaw being, if '{"text":"' occurs
        // in a tweet, the code will think everything subsequent is a new tweet. 
        var jsonTweet = JSON.parse(response.substring(response.lastIndexOf('{"text":"'), response.length));
        geoCodeTweet(jsonTweet); //geoCodeTweet calls createTweetCircle. See circledraw.js to see the function.
        updateMoodBoxes(jsonTweet.stats.mood);           
      }
    }         
  }
}

</script>

</body>
</html>
