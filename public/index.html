<html>
<head>  
   <link rel="stylesheet" type="text/css" href="resource/css/style.css">
   <meta charset="ISO-8859-1">
   <title>Insert title here</title>
   <script src="https://maps.googleapis.com/maps/api/js?callback=initMap" 
              async defer></script><!-- &key=AIzaSyC_IEs6_W9MDGagKWO6ABTzAqJm0O5AyNQ-->   
</head>
<body>
  <br>  
<div class="map" id="map" style="display:block">
   map goes here.
</div>    
<div id="hidden-div" style="display:none">
  <div class="div-color boxes">
      <div class="color-box" id="mood-div" style="background-color: RGB(127,127,127)">Current Tweet Mood</div>
  </div>
  <div class="div-color">
      <div class="color-box2" id="globalMood-div" style="background-color: RGB(127,127,127)">Average Tweet Mood</div>
  </div>
    <br><br>

  <div id='button-div'>
       <button type="button" id="pause-btn" name='pause' onclick="buttonHandler(this)" 
         method="post">Pause Mapping</button>
       <button type="button" id="clear-btn" name='clear' onclick="buttonHandler(this)" 
         method="post">Clear Map</button>
       <button type="button" id="togCircVis-btn" name='togCircVis' style='display: block' onclick="buttonHandler(this)" 
         method="post">Hide Circles</button>   
      <br>             
      Note: You can always pause your streaming, change the parameters in your form, then click 'Resume Streaming'. This will show you your new results on top of the current map. Hit 'Clear Map' to avoid overlapping results.
      <br><br>          
                          
  </div>  
    <br><br>      
  <textarea name="text" id="text1" cols="150" rows="10">
      Live streaming tweets...
  </textarea>   
</div>
  <br>

<!-- Note the use of a button rather than input to submit form; prevents
page refresh, to preserve utility of ajax-->
<div class="form central" id="form-input">
   <form id="form">
     <fieldset>
       <legend>Your guidelines:</legend>

            What subject do you want to follow?<br>
         <input type="text" id="subject" value="BernieSanders"><br>

           Choose a start date for a search, up to one week ago: <br>
         <input type="text" id="startdate" value="3/28/2016" placeholder="day/month/2016"><br>
         <textarea name="error1" id="starterror" cols="100" rows="3" style="display:block">Not quite. Please correct the following: </textarea>   
         
           Choose an end date for your search: <br>
         <input type="text" id="enddate" value="3/30/2016" placeholder="day/month/2016"><br>       
         <textarea name="error2" id="enderror" cols="100" rows="3" style="display:block">Not quite. Please correct the following: </textarea>   
         
           Select your search mode.<br>   
          <select name="modeOptions" form="form-input" id="modeOptions">
            <option value="GET">Search Twitter</option>
            <option value="stream">Live Stream</option>
          </select>

         <br><br>
         <button type="button" id="submit-btn" onclick="buttonHandler(this)" name='submit' style='display: block'
           method="post">Submit</button>  
     </fieldset>
   </form>
</div>   


<script type="text/javascript">

const ReachBoost = 75;
const DefaultCenter = {'lat': 77.113132, 'lng': -42.539063};
const Week = xBrowserWeek();

// Apparently cross-browser standardization of date construction is not so consistent, so I use this as a golden standard: 
function xBrowserWeek(){
  var pointA = new Date('3/3/2016');
  var pointB = new Date('3/10/2016'); 
  return pointB - pointA;
}     

var xhr = new XMLHttpRequest();
var globalMood = {"mood" : [0,0,0], "count" : 1 };
var geoCoder;
var map;  
var startErrMsg;
var endErrMsg;

// Execute functions according to button clicks. Note the flexibility in the logic of clickWrapper(a,b,c,d,e,f) --
// it MUST have the first 4 arguments, but also works with either 5 or 6 args (extras as optional callbacks).
function buttonHandler(source){
  var name  = source.name;

  switch (name){
    case 'submit':
      if (formValidates()){
        clickWrapper(document.getElementById('hidden-div').style, 'display', true, 'block', 'none', ajaxFormSubmit);
        clickWrapper(document.getElementById('submit-btn').style, 'display', true, 'none', 'block');
      } else {
        document.getElementById('starterror').value = startErrMsg;
        document.getElementById('enderror').value = endErrMsg;
        document.getElementById()
      }
      break;
    case 'pause':
      clickWrapper(document.getElementById('pause-btn').firstChild, 'data', true, 'Resume Mapping', 'Pause Mapping', ajaxFormSubmit, ajaxPauseStream);
      break;        
    case 'togCircVis':
      clickWrapper(document.getElementById('togCircVis-btn').firstChild, 'data', true, 'Show Circles', 'Hide Circles', map._togCircVis.call(map));
      break;
    case 'clear':
      map._clearCircles();
      document.getElementById('togCircVis-btn').style.display = 'none';
      document.getElementById('togCircVis-btn').firstChild.data = 'Hide Circles';
      break;       
  }

  /*...clickWrapper(elem, prop, toggleEnabled, oldVal, newVal, oldOnClickMthd, newOnClickMthd.................................*/ /*

  elem is the html element being changed, prop is what property of elem is being changed, oldVal is what prop starts as, newVal is what it finishes as, 
  toggleEnabled is a boolean value, and the last two inputs are optional callbacks. 

  If toggleEnabled is true, elem.prop will toggle back and for between oldVal and newVal. Zero, one, or two callbacks may also be accepted. With zero, no callbacks are fired. With one callback given, clickAction uses that callback for both toggle states. If two are, clickAction uses the first callback when elem.prop == newVal, and the second callback when elem.prop == oldVal.

  If toggleEnabled is false, zero, one, or two callbacks may be accepted. With zero, no callbacks are fired. With one, clickAction uses that action for 
  both toggle states. If two are, clickAction uses the first callback when elem.prop == oldVal, and the second callback when elem.prop == newval. If
  none are, no callbacks are fired. */ 

  function clickWrapper(elem, prop, toggleEnabled, newVal, oldVal, newOnClickMthd, oldOnClickMthd){
    if(toggleEnabled) {
      elem[prop] == oldVal ? clickAction(newVal, oldOnClickMthd) : clickAction(oldVal, newOnClickMthd);
    } else {
      elem[prop] = newVal;
      newOnClickMthd();    
    }

    function clickAction(value, callback){
      elem[prop] = value;
      if (!callback && newOnClickMthd){
        callback = newOnClickMthd;
      }
      if (callback){        
        callback();
      }
    }
  }
}

function formValidates(){
    var start    = document.getElementById('startdate').value;
    var end      = document.getElementById('enddate').value;
    var startObj = new Date(document.getElementById('startdate').value);
    var endObj   = new Date(document.getElementById('enddate').value);
    startErrMsg  = '';
    endErrMsg    = '';

    // & forces all to be checked; && would stop checking if first is invalidated. Needed to see all error messages.
    return (withinWeek() & validStart() & hasFormat());

    function withinWeek(){
      var now = new Date();
      if ((now - startObj) < Week){
        return true; 
      } else {
         startEr += 'That start date is too long ago. Twitter only allows searches for roughly a week back.';
        return false;
      }
    }

    function validStart(){
      if ((endObj - startObj) > 0){
        return true;    
      } else {
          endEr += 'Please make sure your end date is after your start date.'
        return false;
      }
    }

    function hasFormat(){

      if (!checkSizes(start)){
        startEr += 'Incorrect format. Please stick to day/month/year. '
      }
      if (!checkSizes(end)){
        endEr += 'Incorrect format. Please stick to day/month/year. ' 
      }

      alert(checkSizes(end) && checkSizes(start))
      return (checkSizes(end) && checkSizes(start)) ? true : false;

      function checkSizes(date){
        date = date.split('/');
        if (date.length != 3){
          return false;
        } else {
          if ( (date[0].length > 0 && date[0].length < 3) 
            && (date[1].length > 0 && date[1].length < 3)
            && (date[2].length === 4)){
            return true;
          }
        }  
        return false;
      }
    }
  }  

function ajaxPauseStream(){

    // Abort should be sufficient. The request below is a fail safe measure to ensure twitter streaming stops.
  xhr.abort();      
  var pauseXhr = new XMLHttpRequest();
  pauseXhr.open('POST','../pauseStream', true);
  pauseXhr.setRequestHeader('Content-Type','text/plain');
  pauseXhr.send();

  pauseXhr.onreadystatechange = function(){
    if (this.readyState === XMLHttpRequest.DONE){
      if (this.status === 200) {
        document.getElementById("text1").value = 'Streaming paused \n\n' + document.getElementById("text1").value;
      } else {
        alert('There was a problem with the request.')
       }
    }
  };         
}

function ajaxFormSubmit(){

    if (formValidates()){
      sendData(serializeJson(jsonifyForm()));
      document.getElementById('togCircVis-btn').style.display = 'block';        
    } 

  function jsonifyForm(){
    var data = {'subject' : document.getElementById("subject").value,
                'start'   : document.getElementById("startdate").value,
                'end'     : document.getElementById("enddate").value,
                'mode'    : document.getElementById("modeOptions").value }
    return data;
  }    

  function serializeJson(json){

    var urlEncodedData = "";
    var urlEncodedDataPairs = [];
    var name; 

    for (name in json){
        urlEncodedDataPairs.push(encodeURIComponent(name) + '=' + encodeURIComponent(json[name]));
    }
    return urlEncodedDataPairs.join('&').replace(/%20/g, '+');
  }

  function sendData(data){

    xhr.open('POST','../twitterQuery', true);
    xhr.setRequestHeader('Content-Type','application/x-www-form-urlencoded');
    xhr.send(data);
    xhr.onreadystatechange = function (){

      if (this.readyState === XMLHttpRequest.LOADING ||
          this.readyState === XMLHttpRequest.DONE){
          if (this.status === 200) {
            var responseJSON = parseResponse(this.responseText);
          } else {
            // alert('There was a problem with the request.')
          }
      }

      function parseResponse(response){
        // '{"text":"'' delimits the start of a new tweet -- a possible flaw being, if '{"text":"' occurs
        // in a tweet, the code will think everything subsequent is a new tweet, ruining everything. 
        var jsonTweet = JSON.parse(response.substring(response.lastIndexOf('{"text":"'), response.length));
        displayText(document.getElementById('text1'));
        updateMoodBox(document.getElementById('mood-div'), jsonTweet.stats.mood);
        updateAverageMoodBox(jsonTweet.stats.mood);
        geoCodeTweet(jsonTweet);
        return jsonTweet;

        function displayText(html){

          html.value = (html.value + '\n\n' + jsonTweet.text + '\n\n' + ' . .  .   .  . .  .   .  . .');
        }
         
        function updateMoodBox(html, mood){

          mood = mood.toString();
          html.style = 'background-color: RGB(' + mood + ')';  
        }
          
        function updateAverageMoodBox(mood){

          var RGB = [];
          mood.forEach(function(value, i){
            globalMood.mood[i] += Number(value);
            RGB[i] = (globalMood.mood[i] / globalMood.count).toFixed(0);
          }) 
          updateMoodBox(document.getElementById('globalMood-div'), RGB);
          globalMood.count++;
        }

        function geoCodeTweet(tweet){

          var center  = null;
          if (tweet.location != null){
            var location = tweet.location.substring(3, tweet.location.length);
            var id       = tweet.location.substring(0, 3);
            switch(id){
              case 'CO:':
                alert("~~~~ CO FOUND: Location is " + location)
                var latLng = location.split(",");
                center = {'lat': Number(latLng[0]), 'lng': Number(latLng[1])};
                alert("CO center is " + center.lat() + " " + center.lng());
                break;
              case 'ST':
                  // the UL code should work just as well for street names; allow to continue through to UL caes.
              case 'UL:':
                geoCoder.geocode({'address':location}, function(results, status){
                  if (status == google.maps.GeocoderStatus.OK){
                    if (results[0].geometry != null && results[0].geometry.location != null){
                        center = results[0].geometry.location;
                        drawTweetCircle(tweet, center);
                    }                     
                  } else if (status == google.maps.GeocoderStatus.OVER_QUERY_LIMIT){
                    alert('Oh no! This app has maxed out its queries. Try again later.')
                  }  
                });               
                break;   
            }
          } else if (location == null || center == null){
          // The middle of Iceland, for non-located tweets!
            center = DefaultCenter;
          }
          drawTweetCircle(tweet, center);   
        }

        function drawTweetCircle(tweet, center){

          var radius      = tweet.stats.reach ? tweet.stats.reach * ReachBoost : ReachBoost;
          var tweetCircle = initTweetCircle();
          tweetCircle.initListeners();
          tweetCircle._storeInMap(map);

          function initTweetCircle(){
              
            var circle = new google.maps.Circle({
              'strokeColor'  : 'RGB(' + tweet.stats.mood.toString() + ')',
              'strokeOpacity': .8,
              'strokeWeight' : 2,
              'fillColor'    : 'RGB(' + tweet.stats.mood.toString() + ')',
              'fillOpacity'  : .35, 
              'map'          : map,
              'center'       : center,
              'radius'       : radius,
              'draggable'    : true,
              'clickable'    : true,
            });

            circle.infoWindow = initInfoWindow(); 
            circle.timer;

            function initInfoWindow(){
              var content = ("<p>"
                            + "User:<br/> "     + tweet.user.name   + "<br/><br/>" 
                            + "Text:<br/> "     + tweet.text        + "<br/><br/>" 
                            + "Location:<br/> " + tweet.location    + "<br/><br/>" 
                            + "Mood:<br/> "     + tweet.stats.mood  + "<br/><br/>" 
                            + "Reach:<br/> "    + tweet.stats.reach + "<br/><br/>" 
                            + "Reach:<br/> "    + tweet.stats.reach + "<br/><br/>"                                                   
                            + "</p>");
              return new google.maps.InfoWindow({
                'content'        : content,
                'maxWidth'       : 250,
                'disableAutoPan' : true,
              });
            }

            circle.initListeners = function(){

              this.addListener('mouseover', function(){
                explodeView();
                this.infoWindow.setPosition(this.getBounds().getNorthEast());
                this.infoWindow.open(map);
                this.timer = setInterval(function(){
                    map.panTo(this.getCenter());
                  }.bind(circle), 1000)
                function explodeView(){
                  var radiusExtender = ((300 - tweet.stats.reach) + 1) / 60;
                  radiusExtender > 1.15 ? circle.setRadius(radiusExtender * radius) : circle.setRadius(radius * 1.15);
                }  
              });
     
              this.addListener('mouseout', function(){
                this.setRadius(radius);
                this.infoWindow.close(map);
                clearTimeout(this.timer);
              });

              this.addListener('drag', function(){
                this.infoWindow.setMap(null);
              });

              this.addListener('dragend', function(){
                this.setMap(map);
                this.infoWindow.setPosition(this.getBounds().getNorthEast());
                this.infoWindow.setMap(map);
              });

              this.addListener('dblclick', function(){
                this.infoWindow.setMap(null);
                this.setMap(null);
              });            
            }
            return circle; 
          }
        }          
      }
    }         
  }
}

function initMap(){

  addCircleStorageToMap();
  var props     = setProperties();
  var styles    = setStyles();
  var styledMap = new google.maps.StyledMapType(styles, {name: 'Styled Map'});
  geoCoder      = new google.maps.Geocoder();
  map           = new google.maps.Map(document.getElementById('map'), props);
  map.mapTypes.set('map_style', styledMap);
  map.setMapTypeId('map_style');

  function setProperties(){
    return {
      'streetViewControl'      : false,
      'disableDoubleClickZoom' : true,      
      'center'                 : new google.maps.LatLng(42.877742, -97.380979),
      'zoom'                   : 4,
      'minZoom'                : 2,
      'maxZoom'                : 12,
      'mapTypeId'              : [google.maps.MapTypeId.ROADMAP, 'map_style'],
    };
  }

  function setStyles(){
    // Styles from the fantastic Google Styled Maps Wizard, http://googlemaps.github.io/js-samples/styledmaps/wizard/index.html
    return [
      {
        "featureType": "road",
        "stylers": [
          { "visibility": "off" }
        ]
      },{
        "featureType": "poi",
        "stylers": [
          { "visibility": "off" }
        ]
      },{
        "featureType": "transit",
        "stylers": [
          { "visibility": "off" }
        ]
      },{
        "elementType": "labels",
        "stylers": [
          { "lightness": 49 }
        ]
      },{
        "featureType": "administrative",
        "elementType": "geometry.fill",
        "stylers": [
          { "visibility": "off" }
        ]
      },{
        "featureType": "administrative",
        "elementType": "geometry.stroke",
        "stylers": [
          { "lightness": 48 }
        ]
      }
    ];      
  }

  function addCircleStorageToMap(){

    var listeners = ['click','dblclick','drag','dragend','mouseover','mouseout'];
    google.maps.Map.prototype.circles = [];

    google.maps.Map.prototype._getCircles = function(){
      return this.circles;
    };

    google.maps.Map.prototype._clearCircles = function(){
      this.circles.forEach(function(circle){
        listeners.forEach(function(listener){
          google.maps.event.clearListeners(circle, listener);
        });
        circle.setMap(null);
       });
      this.circles = [];
    };

    google.maps.Map.prototype._togCircVis = function(){
      this.circles.forEach(function(circle){
        circle.getMap() != null ? circle.setMap(null) : circle.setMap(map);
      })
    }

    google.maps.Circle.prototype._storeInMap = function(map){
      if(map){
        map.circles.push(this);
      }
    }
  }
}

</script>
</body>
</html>
